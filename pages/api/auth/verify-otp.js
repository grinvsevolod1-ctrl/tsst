
import fs from 'fs'; import path from 'path'; import { sign } from '../../../lib/auth.js'; import { readUsers, writeUsers } from '../../../lib/db.js'
export default function handler(req,res){ if (req.method!=='POST') return res.status(405).json({error:'Only POST'}); const { email, code } = req.body; const TMP = path.join(process.cwd(),'data','otps.json'); if (!fs.existsSync(TMP)) return res.status(400).json({ error:'no otp' }); const otps = JSON.parse(fs.readFileSync(TMP)); const entry = otps[email]; if (!entry || entry.code !== code || Date.now() > entry.expires) return res.status(400).json({ error:'invalid code' }); delete otps[email]; fs.writeFileSync(TMP, JSON.stringify(otps)); const users = readUsers(); let user = users.find(u=>u.email===email); if (!user){ user = { id: 'u_'+Math.random().toString(36).slice(2,9), email, createdAt: new Date().toISOString() }; users.push(user); writeUsers(users) } const token = sign({ sub: user.id, email: user.email }, { expiresIn: '7d' }); res.setHeader('Set-Cookie', `token=${token}; HttpOnly; Path=/; Max-Age=${7*24*3600}`); res.json({ ok:true, user }) }
