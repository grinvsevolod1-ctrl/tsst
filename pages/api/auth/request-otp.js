
import fs from 'fs'; import path from 'path'; import nodemailer from 'nodemailer'
const TMP = path.join(process.cwd(),'data','otps.json'); if (!fs.existsSync(path.dirname(TMP))) fs.mkdirSync(path.dirname(TMP), { recursive:true }); if (!fs.existsSync(TMP)) fs.writeFileSync(TMP,'{}')
export default async function handler(req,res){ if (req.method!=='POST') return res.status(405).json({error:'Only POST'}); const { email } = req.body; if(!email) return res.status(400).json({error:'email required'}); const code = Math.floor(100000+Math.random()*900000).toString(); const data = JSON.parse(fs.readFileSync(TMP)); data[email] = { code, expires: Date.now()+1000*60*10 }; fs.writeFileSync(TMP, JSON.stringify(data)); try{ const transporter = nodemailer.createTransport({ host: process.env.SMTP_HOST, port: parseInt(process.env.SMTP_PORT||'587'), secure: process.env.SMTP_SECURE==='true', auth: { user: process.env.SMTP_USER, pass: process.env.SMTP_PASS } }); await transporter.sendMail({ from: process.env.SMTP_FROM || 'BVETRA <no-reply@example.com>', to: email, subject: 'Ваш код входа', text: `Код: ${code}` }); res.json({ ok:true }) }catch(e){ console.error(e); res.status(500).json({ error: String(e) }) } }
