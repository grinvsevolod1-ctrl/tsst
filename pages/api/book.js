
import { readOrders, writeOrders } from '../../lib/db.js'; import axios from 'axios'
export default async function handler(req,res){ if (req.method!=='POST') return res.status(405).json({ error:'Only POST' }); const p = req.body; if (!p.pickup||!p.dropoff||!p.phone) return res.status(400).json({ error:'missing' }); const orders = readOrders(); const order = { id: 'o_'+Math.random().toString(36).slice(2,9), pickup: p.pickup, dropoff: p.dropoff, car: p.car || 'economy', phone: p.phone, notes: p.notes||'', createdAt: new Date().toISOString(), status: 'new' }; orders.unshift(order); writeOrders(orders); try{ if (process.env.BITRIX_WEBHOOK_URL) await axios.post(process.env.BITRIX_WEBHOOK_URL, { fields:{ TITLE:`Трансфер: ${order.pickup} → ${order.dropoff}`, COMMENT: order.notes } }); if (process.env.TELEGRAM_BOT_TOKEN && process.env.TELEGRAM_CHAT_ID) await axios.post(`https://api.telegram.org/bot${process.env.TELEGRAM_BOT_TOKEN}/sendMessage`, { chat_id: process.env.TELEGRAM_CHAT_ID, text: `Новый заказ: ${order.pickup} → ${order.dropoff} Тел: ${order.phone}` }); }catch(e){ console.error(e) } res.json({ ok:true, order }) }
